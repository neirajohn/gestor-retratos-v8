<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Retratos Empresariales</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .modal {
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal.show {
            opacity: 1;
            visibility: visible;
        }
        .modal.hide {
            opacity: 0;
            visibility: hidden;
        }
        .loading-overlay {
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(4px);
            z-index: 60;
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body class="p-8 md:p-12 lg:p-16">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay fixed inset-0 flex items-center justify-center">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500"></div>
            <p class="mt-4 text-gray-700 font-semibold">Cargando datos...</p>
        </div>
    </div>

    <!-- Contenedor Principal de la Aplicación -->
    <div class="max-w-7xl mx-auto bg-white rounded-2xl shadow-xl p-6 md:p-8 lg:p-10 border border-gray-200">
        
        <!-- Encabezado y Contadores -->
        <header class="mb-8 md:mb-10">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900 text-center mb-2" id="project-title-display">Gestión de Retratos</h1>
            <p class="text-center text-gray-500 mb-6">Un proyecto de **Guardián de Momentos**</p>
            
            <!-- Contenedor para la configuración y el botón de acción -->
            <div class="flex flex-col md:flex-row md:items-end justify-between gap-4 mb-6">
                <div class="flex-grow grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="project-title-input" class="block text-sm font-medium text-gray-700 mb-1">Nombre del Proyecto</label>
                        <input type="text" id="project-title-input" placeholder="Ej. Anuario 2024" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200">
                    </div>
                    <div>
                        <label for="total-people-input" class="block text-sm font-medium text-gray-700 mb-1">Total de Personas</label>
                        <input type="number" id="total-people-input" placeholder="Ej. 108" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200">
                    </div>
                </div>
                <button id="generate-contact-sheet-btn" class="flex items-center justify-center gap-2 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition-all duration-200 transform hover:scale-105 shadow-md self-end md:self-auto">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm12 0H6v12h10V4zm-1 2H5v10h10V6z" clip-rule="evenodd" />
                    </svg>
                    <span>Hoja de Contacto</span>
                </button>
            </div>
            
            <p class="text-xs text-gray-400 text-right mb-4">ID de usuario: <span id="user-id-display">Cargando...</span></p>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-center">
                <div class="bg-blue-100 text-blue-800 p-4 rounded-xl shadow-inner">
                    <div class="text-xl md:text-2xl font-bold" id="total-count">0</div>
                    <div class="text-sm font-medium">Total de Personas</div>
                </div>
                <div class="bg-green-100 text-green-800 p-4 rounded-xl shadow-inner">
                    <div class="text-xl md:text-2xl font-bold" id="photographed-count">0</div>
                    <div class="text-sm font-medium">Retratadas</div>
                </div>
                <div class="bg-red-100 text-red-800 p-4 rounded-xl shadow-inner">
                    <div class="text-xl md:text-2xl font-bold" id="pending-count">0</div>
                    <div class="text-sm font-medium">Pendientes</div>
                </div>
                <div class="bg-purple-100 text-purple-800 p-4 rounded-xl shadow-inner">
                    <div class="text-xl md:text-2xl font-bold" id="progress-percentage">0%</div>
                    <div class="text-sm font-medium">Progreso</div>
                </div>
            </div>

            <!-- Barra de Progreso -->
            <div class="mt-4 bg-gray-200 rounded-full h-4 overflow-hidden shadow-inner">
                <div id="progress-bar" class="bg-purple-500 h-full transition-all duration-500" style="width: 0%;"></div>
            </div>

        </header>

        <!-- Sección de Gestión de Tiempo -->
        <section class="bg-gray-50 rounded-xl p-4 mb-8 border border-gray-200 shadow-sm">
            <h2 class="text-lg md:text-xl font-bold text-gray-900 mb-3 text-center">Gestión de Tiempo de Sesión</h2>
            <div class="flex flex-col sm:flex-row items-center justify-center space-y-3 sm:space-y-0 sm:space-x-6">
                <div class="flex items-center space-x-2">
                    <p class="text-sm text-gray-500">Inicio:</p>
                    <p class="text-base font-bold text-gray-800" id="session-start-time">--:--:--</p>
                </div>
                <div class="flex items-center space-x-2">
                    <p class="text-sm text-gray-500">Transcurrido:</p>
                    <p class="text-base font-bold text-gray-800" id="session-elapsed-time">00:00:00</p>
                </div>
                <button id="end-session-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-full transition-all duration-200 transform hover:scale-105 text-sm">
                    Concluir Sesión
                </button>
            </div>
            <div id="session-duration-display" class="mt-4 p-3 bg-blue-100 text-blue-800 rounded-lg font-bold text-center text-sm" style="display: none;">
                Duración de la sesión: <span id="session-total-duration"></span>
            </div>
        </section>

        <!-- Barra de Búsqueda -->
        <div class="mb-6 md:mb-8">
            <input type="text" id="search-input" placeholder="Buscar por nombre, departamento o turno..." class="w-full px-5 py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 shadow-sm">
        </div>
        
        <!-- Lista de Personas -->
        <div id="person-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 md:gap-6">
            <!-- Los elementos de la lista se renderizarán aquí -->
        </div>

    </div>

    <!-- Modal para Detalle y Acción -->
    <div id="person-modal" class="modal hide fixed inset-0 z-50 overflow-y-auto" style="background-color: rgba(0, 0, 0, 0.6);">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl p-6 md:p-8 w-full max-w-xl shadow-2xl transform transition-all scale-95 duration-300">
                <div class="flex justify-between items-start mb-4">
                    <h3 class="text-2xl font-bold text-gray-900" id="modal-title"></h3>
                    <button class="text-gray-400 hover:text-gray-600 transition" id="close-modal-btn">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>

                <!-- Sección para editar datos -->
                <div class="text-gray-700 space-y-4 mb-6">
                    <div>
                        <label for="modal-name-input" class="block text-sm font-medium text-gray-700">Nombre:</label>
                        <input type="text" id="modal-name-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200">
                    </div>
                    <div>
                        <label for="modal-dept-select" class="block text-sm font-medium text-gray-700">Departamento:</label>
                        <select id="modal-dept-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200">
                            <!-- Opciones se llenarán dinámicamente -->
                        </select>
                    </div>
                    <div>
                        <label for="modal-shift-select" class="block text-sm font-medium text-gray-700">Turno:</label>
                        <select id="modal-shift-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200">
                            <!-- Opciones se llenarán dinámicamente -->
                        </select>
                    </div>
                    <div>
                        <label for="modal-job-title-input" class="block text-sm font-medium text-gray-700">Puesto de Trabajo:</label>
                        <input type="text" id="modal-job-title-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200">
                    </div>
                    <div>
                        <label for="modal-dob-input" class="block text-sm font-medium text-gray-700">Fecha de Nacimiento:</label>
                        <input type="date" id="modal-dob-input" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200">
                    </div>
                </div>

                <!-- Botón para guardar cambios en los datos -->
                <button id="save-changes-btn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 rounded-full transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50 mb-4">
                    Guardar Cambios
                </button>

                <!-- Sección de Gestión de Fotos y Texto -->
                <div id="photo-text-section" class="space-y-4">
                    <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <h4 class="font-semibold text-gray-800 mb-2">Texto para Anuario</h4>
                        <textarea id="yearbook-text-input" class="w-full h-24 p-3 rounded-lg border border-gray-300 resize-none focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>

                    <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <h4 class="font-semibold text-gray-800 mb-2">Subir Fotos (3-5 máximo)</h4>
                        <input type="file" id="photo-input" accept="image/*" multiple class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        <div id="photo-preview-container" class="mt-4 grid grid-cols-3 gap-2"></div>
                    </div>
                </div>

                <p class="text-xs text-center text-gray-400 mt-4" id="capture-time-display" style="display:none;"></p>
                <button id="mark-photographed-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-full transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 mt-6">
                    Marcar como Fotografiado
                </button>
            </div>
        </div>
    </div>
    
    <!-- Scripts de Lógica de la App -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, query, onSnapshot, getDocs, addDoc, serverTimestamp, getCountFromServer } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('debug');
        
        // Variables globales proporcionadas por el entorno
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let userId = null;
        let unsubscribePeople = null;
        let unsubscribeProject = null;

        // Simulación de una base de datos en memoria (los cambios se perderán al refrescar)
        let allPeopleData = [];
        let sessionStartTime;
        let timerInterval;

        // Elementos del DOM
        const loadingOverlayEl = document.getElementById('loading-overlay');
        const userIdDisplayEl = document.getElementById('user-id-display');
        const totalCountEl = document.getElementById('total-count');
        const photographedCountEl = document.getElementById('photographed-count');
        const pendingCountEl = document.getElementById('pending-count');
        const progressPercentageEl = document.getElementById('progress-percentage');
        const progressBarEl = document.getElementById('progress-bar');
        const searchInput = document.getElementById('search-input');
        const personListEl = document.getElementById('person-list');
        const personModal = document.getElementById('person-modal');
        const modalTitleEl = document.getElementById('modal-title');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const markPhotographedBtn = document.getElementById('mark-photographed-btn');
        const yearbookTextInput = document.getElementById('yearbook-text-input');
        const photoInput = document.getElementById('photo-input');
        const photoPreviewContainer = document.getElementById('photo-preview-container');
        const sessionStartTimeEl = document.getElementById('session-start-time');
        const sessionElapsedTimeEl = document.getElementById('session-elapsed-time');
        const endSessionBtn = document.getElementById('end-session-btn');
        const sessionDurationDisplayEl = document.getElementById('session-duration-display');
        const sessionTotalDurationEl = document.getElementById('session-total-duration');
        const projectTitleInput = document.getElementById('project-title-input');
        const projectTitleDisplay = document.getElementById('project-title-display');
        const totalPeopleInput = document.getElementById('total-people-input');
        const generateContactSheetBtn = document.getElementById('generate-contact-sheet-btn');
        
        // Nuevos elementos editables del modal
        const modalNameInput = document.getElementById('modal-name-input');
        const modalDeptSelect = document.getElementById('modal-dept-select');
        const modalShiftSelect = document.getElementById('modal-shift-select');
        const modalJobTitleInput = document.getElementById('modal-job-title-input');
        const modalDobInput = document.getElementById('modal-dob-input');
        const saveChangesBtn = document.getElementById('save-changes-btn');
        const captureTimeDisplayEl = document.getElementById('capture-time-display');

        const departments = ['Ventas', 'Recursos Humanos', 'Ingeniería', 'Marketing', 'Finanzas'];
        const shifts = ['Mañana', 'Tarde', 'Noche', 'Mixto', 'Turno Completo'];
        const jobTitles = ['Analista', 'Gerente', 'Asistente', 'Director', 'Especialista'];

        // Referencia a las colecciones de Firestore
        const getPeopleCollection = (uid) => collection(db, `artifacts/${appId}/users/${uid}/people`);
        const getProjectDoc = (uid) => doc(db, `artifacts/${appId}/users/${uid}/projects/main`);

        // Función para llenar los select del modal
        const populateModalSelects = () => {
            modalDeptSelect.innerHTML = '';
            modalShiftSelect.innerHTML = '';
            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                modalDeptSelect.appendChild(option);
            });
            shifts.forEach(shift => {
                const option = document.createElement('option');
                option.value = shift;
                option.textContent = shift;
                modalShiftSelect.appendChild(option);
            });
        };

        // Función para crear los datos iniciales
        const createInitialData = async (numPeople) => {
            if (!userId) {
                console.error("Error: El ID de usuario no está disponible.");
                return;
            }
            
            const peopleCol = getPeopleCollection(userId);
            const querySnapshot = await getDocs(peopleCol);
            
            // Si ya hay datos, no creamos nuevos
            if (!querySnapshot.empty) {
                console.log("Los datos ya existen en la base de datos. No se generarán nuevos.");
                return;
            }

            console.log(`Generando ${numPeople} nuevos documentos...`);
            for (let i = 1; i <= numPeople; i++) {
                const newPerson = {
                    nombre: `Persona de Prueba ${i}`,
                    departamento: departments[Math.floor(Math.random() * departments.length)],
                    turno: shifts[Math.floor(Math.random() * shifts.length)],
                    puestoDeTrabajo: jobTitles[Math.floor(Math.random() * jobTitles.length)],
                    fechaNacimiento: `1990-${String(Math.floor(Math.random() * 12) + 1).padStart(2, '0')}-${String(Math.floor(Math.random() * 28) + 1).padStart(2, '0')}`,
                    isPhotographed: false,
                    horaCaptura: null,
                    yearbookText: '',
                    photos: []
                };
                try {
                    await addDoc(peopleCol, newPerson);
                } catch (e) {
                    console.error("Error al añadir un nuevo documento: ", e);
                }
            }
            console.log("Generación de datos iniciales completa.");
        };

        // Función para actualizar los contadores y la barra de progreso
        const updateCounts = (people) => {
            const total = people.length;
            const photographed = people.filter(p => p.isPhotographed).length;
            const pending = total - photographed;
            const progress = total > 0 ? (photographed / total) * 100 : 0;

            totalCountEl.textContent = total;
            photographedCountEl.textContent = photographed;
            pendingCountEl.textContent = pending;
            progressPercentageEl.textContent = `${Math.round(progress)}%`;
            progressBarEl.style.width = `${progress}%`;
        };

        // Función para renderizar la lista de personas
        const renderPeopleList = (people, filterText = '') => {
            personListEl.innerHTML = '';
            const filteredPeople = people.filter(person =>
                person.nombre.toLowerCase().includes(filterText.toLowerCase()) ||
                person.departamento.toLowerCase().includes(filterText.toLowerCase()) ||
                person.turno.toLowerCase().includes(filterText.toLowerCase())
            );

            filteredPeople.forEach(person => {
                const isPhotographed = person.isPhotographed;
                const cardColorClass = isPhotographed ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200';
                const textColorClass = isPhotographed ? 'text-green-800' : 'text-red-800';
                
                const card = document.createElement('div');
                card.className = `relative p-4 rounded-xl shadow-lg border-2 cursor-pointer transition-all duration-300 transform hover:scale-105 ${cardColorClass}`;
                card.dataset.id = person.id;

                card.innerHTML = `
                    <div class="text-xs font-semibold ${textColorClass} mb-1">${isPhotographed ? 'Retratado' : 'Pendiente'}</div>
                    <h4 class="text-lg md:text-xl font-bold text-gray-900 mb-1">${person.nombre}</h4>
                    <p class="text-sm text-gray-600">${person.departamento} - ${person.turno}</p>
                    <button class="toggle-status-btn absolute bottom-3 right-3 p-2 rounded-full shadow-md transition-all duration-200 transform hover:scale-110
                        ${isPhotographed ? 'bg-green-500 hover:bg-green-600' : 'bg-red-500 hover:bg-red-600'}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                    </button>
                `;
                personListEl.appendChild(card);
            });
        };
        
        // --- Lógica del Temporizador de Sesión ---
        const startSessionTimer = () => {
            // No iniciar el temporizador si ya está corriendo
            if (timerInterval) return;

            sessionStartTime = new Date();
            sessionStartTimeEl.textContent = sessionStartTime.toLocaleTimeString();

            timerInterval = setInterval(() => {
                const now = new Date();
                const elapsedSeconds = Math.floor((now - sessionStartTime) / 1000);
                const hours = Math.floor(elapsedSeconds / 3600);
                const minutes = Math.floor((elapsedSeconds % 3600) / 60);
                const seconds = elapsedSeconds % 60;

                const formattedTime = [
                    String(hours).padStart(2, '0'),
                    String(minutes).padStart(2, '0'),
                    String(seconds).padStart(2, '0')
                ].join(':');

                sessionElapsedTimeEl.textContent = formattedTime;
            }, 1000);
        };

        const endSession = async () => {
            clearInterval(timerInterval);
            timerInterval = null;
            const endTime = new Date();
            const totalMilliseconds = endTime - sessionStartTime;
            const hours = Math.floor(totalMilliseconds / (1000 * 60 * 60));
            const minutes = Math.floor((totalMilliseconds % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((totalMilliseconds % (1000 * 60)) / 1000);

            const totalDuration = `${hours}h ${minutes}m ${seconds}s`;
            sessionTotalDurationEl.textContent = totalDuration;
            sessionDurationDisplayEl.style.display = 'block';
            endSessionBtn.style.display = 'none';
            sessionElapsedTimeEl.style.display = 'none';

            // Guardar la duración de la sesión en Firestore
            if (userId) {
                const projectRef = getProjectDoc(userId);
                try {
                    await setDoc(projectRef, { sessionEndTime: serverTimestamp(), sessionDuration: totalDuration }, { merge: true });
                } catch (e) {
                    console.error("Error al guardar la duración de la sesión:", e);
                }
            }
        };

        // Event listener para el botón de concluir sesión
        endSessionBtn.addEventListener('click', endSession);

        // --- Fin de la lógica del Temporizador ---

        // Event listener para el campo de búsqueda
        searchInput.addEventListener('input', (e) => {
            renderPeopleList(allPeopleData, e.target.value);
        });
        
        // Event listener para generar la hoja de contacto
        generateContactSheetBtn.addEventListener('click', () => {
            const projectTitle = projectTitleInput.value || 'Gestión de Retratos';
            const htmlContent = `
                <!DOCTYPE html>
                <html lang="es">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>Hoja de Contacto - ${projectTitle}</title>
                    <style>
                        body { font-family: 'Inter', sans-serif; margin: 0; padding: 2rem; }
                        header { text-align: center; margin-bottom: 2rem; }
                        h1 { font-size: 2rem; font-weight: bold; }
                        p { color: #555; }
                        table { width: 100%; border-collapse: collapse; margin-top: 2rem; }
                        th, td { border: 1px solid #ccc; padding: 0.75rem; text-align: left; vertical-align: top; }
                        th { background-color: #f3f4f6; font-weight: 600; }
                        tr:nth-child(even) { background-color: #f9f9f9; }
                        @media print {
                            body { -webkit-print-color-adjust: exact; color-adjust: exact; }
                            header, table { page-break-inside: avoid; }
                        }
                    </style>
                </head>
                <body>
                    <header>
                        <h1>Hoja de Contacto: ${projectTitle}</h1>
                        <p>Un proyecto de **Guardián de Momentos**</p>
                    </header>
                    <table>
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Nombre</th>
                                <th>Departamento</th>
                                <th>Turno</th>
                                <th>Puesto</th>
                                <th>Texto Anuario</th>
                                <th>Fotos</th>
                                <th>Firma</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${allPeopleData.map((person, index) => `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td>${person.nombre}</td>
                                    <td>${person.departamento}</td>
                                    <td>${person.turno}</td>
                                    <td>${person.puestoDeTrabajo}</td>
                                    <td>${person.yearbookText || ''}</td>
                                    <td>${person.photos.length > 0 ? `${person.photos.length} Fotos` : ''}</td>
                                    <td></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank');
            if (printWindow) {
                printWindow.document.open();
                printWindow.document.write(htmlContent);
                printWindow.document.close();
                printWindow.focus();
                // Esperar un momento para que el DOM se renderice antes de imprimir
                setTimeout(() => {
                    printWindow.print();
                }, 500);
            } else {
                console.error('Por favor, permite ventanas emergentes para generar la hoja de contacto.');
            }
        });

        // Event listener para los elementos de la lista (abrir modal o cambiar estado rápido)
        personListEl.addEventListener('click', async (e) => {
            const card = e.target.closest('div[data-id]');
            if (!card) return;

            const isQuickUpdate = e.target.closest('.toggle-status-btn');
            const personId = card.dataset.id;
            const person = allPeopleData.find(p => p.id === personId);
            
            if (!person) {
                console.error("Persona no encontrada en los datos locales:", personId);
                return;
            }
            
            const personRef = doc(db, `artifacts/${appId}/users/${userId}/people/${personId}`);
            
            if (isQuickUpdate) {
                // Lógica de actualización rápida
                const newStatus = !person.isPhotographed;
                const updateData = {
                    isPhotographed: newStatus
                };
                if (newStatus) {
                    updateData.horaCaptura = new Date().toLocaleString();
                } else {
                    updateData.horaCaptura = null;
                }
                
                try {
                    await updateDoc(personRef, updateData);
                } catch (e) {
                    console.error("Error al actualizar el estado de la persona:", e);
                }

            } else {
                // Lógica para abrir el modal
                modalTitleEl.textContent = person.nombre;
                
                // Llenar campos del modal para la edición
                modalNameInput.value = person.nombre || '';
                modalDeptSelect.value = person.departamento || '';
                modalShiftSelect.value = person.turno || '';
                modalJobTitleInput.value = person.puestoDeTrabajo || '';
                modalDobInput.value = person.fechaNacimiento || '';

                yearbookTextInput.value = person.yearbookText || '';
                photoInput.value = '';
                photoPreviewContainer.innerHTML = '';
                if (person.photos && person.photos.length > 0) {
                    person.photos.forEach(photoBase64 => {
                        const img = document.createElement('img');
                        img.src = photoBase64;
                        img.className = "w-full h-auto rounded-md shadow-md";
                        photoPreviewContainer.appendChild(img);
                    });
                }

                // Lógica dinámica del botón de fotografiado
                markPhotographedBtn.dataset.id = person.id;
                if (person.isPhotographed) {
                    markPhotographedBtn.textContent = 'Marcar como Pendiente';
                    markPhotographedBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    markPhotographedBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                    captureTimeDisplayEl.textContent = `Capturado el: ${person.horaCaptura}`;
                    captureTimeDisplayEl.style.display = 'block';
                } else {
                    markPhotographedBtn.textContent = 'Marcar como Fotografiado';
                    markPhotographedBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                    markPhotographedBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    captureTimeDisplayEl.style.display = 'none';
                }

                personModal.classList.remove('hide');
                personModal.classList.add('show');
            }
        });

        // Event listener para cerrar el modal
        closeModalBtn.addEventListener('click', () => {
            personModal.classList.remove('show');
            personModal.classList.add('hide');
        });

        // Event listener para guardar cambios en los datos de la persona
        saveChangesBtn.addEventListener('click', async () => {
            const personId = markPhotographedBtn.dataset.id;
            if (!personId || !userId) {
                console.error("ID de persona o de usuario no encontrado.");
                return;
            }

            const personRef = doc(db, `artifacts/${appId}/users/${userId}/people/${personId}`);
            const updateData = {
                nombre: modalNameInput.value.trim(),
                departamento: modalDeptSelect.value,
                turno: modalShiftSelect.value,
                puestoDeTrabajo: modalJobTitleInput.value.trim(),
                fechaNacimiento: modalDobInput.value.trim(),
            };
            
            try {
                await updateDoc(personRef, updateData);
                personModal.classList.remove('show');
                personModal.classList.add('hide');
            } catch (e) {
                console.error("Error al guardar cambios:", e);
            }
        });

        // Event listener para marcar como fotografiado
        markPhotographedBtn.addEventListener('click', async (e) => {
            const personId = e.target.dataset.id;
            if (!personId || !userId) {
                console.error("ID de persona o de usuario no encontrado.");
                return;
            }

            const person = allPeopleData.find(p => p.id === personId);
            if (!person) {
                console.error("Persona no encontrada en los datos locales:", personId);
                return;
            }

            const personRef = doc(db, `artifacts/${appId}/users/${userId}/people/${personId}`);
            
            const isCurrentlyPhotographed = person.isPhotographed;
            const updateData = {};

            if (isCurrentlyPhotographed) {
                // Si ya está fotografiado, lo marcamos como pendiente
                updateData.isPhotographed = false;
                updateData.horaCaptura = null;
                updateData.yearbookText = '';
                updateData.photos = [];
            } else {
                // Si está pendiente, lo marcamos como fotografiado
                const yearbookText = yearbookTextInput.value.trim();
                const photoFiles = photoInput.files;
                const photos = [];

                if (photoFiles.length > 0) {
                    for (let i = 0; i < photoFiles.length; i++) {
                        if (i >= 5) break;
                        const file = photoFiles[i];
                        photos.push(await new Promise(resolve => {
                            const reader = new FileReader();
                            reader.onload = (e) => resolve(e.target.result);
                            reader.readAsDataURL(file);
                        }));
                    }
                }

                updateData.isPhotographed = true;
                updateData.horaCaptura = new Date().toLocaleString();
                updateData.yearbookText = yearbookText;
                updateData.photos = photos;
            }

            try {
                await updateDoc(personRef, updateData);
                personModal.classList.remove('show');
                personModal.classList.add('hide');
            } catch (e) {
                console.error("Error al actualizar la persona:", e);
            }
        });

        // Event listener para la previsualización de fotos
        photoInput.addEventListener('change', async (e) => {
            photoPreviewContainer.innerHTML = '';
            const files = e.target.files;
            if (files && files.length > 0) {
                for (let i = 0; i < files.length && i < 5; i++) {
                    const file = files[i];
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = "w-full h-auto rounded-md shadow-md";
                        photoPreviewContainer.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                }
            }
        });

        // Event listeners para los nuevos campos de entrada
        totalPeopleInput.addEventListener('input', async (e) => {
            const newTotal = parseInt(e.target.value, 10);
            if (!isNaN(newTotal) && newTotal > 0 && userId) {
                const projectRef = getProjectDoc(userId);
                try {
                    await setDoc(projectRef, { totalPeople: newTotal }, { merge: true });
                } catch (e) {
                    console.error("Error al actualizar el número total de personas:", e);
                }
            }
        });

        projectTitleInput.addEventListener('input', async (e) => {
            if (userId) {
                const newTitle = e.target.value || 'Gestión de Retratos';
                const projectRef = getProjectDoc(userId);
                try {
                    await setDoc(projectRef, { title: newTitle }, { merge: true });
                } catch (e) {
                    console.error("Error al actualizar el título del proyecto:", e);
                }
            }
        });

        // Escuchadores de Firestore para mantener la UI sincronizada
        const setupFirestoreListeners = (uid) => {
            // Escuchar el documento del proyecto
            unsubscribeProject = onSnapshot(getProjectDoc(uid), (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const projectData = docSnapshot.data();
                    projectTitleInput.value = projectData.title || '';
                    projectTitleDisplay.textContent = projectData.title || 'Gestión de Retratos';
                    totalPeopleInput.value = projectData.totalPeople || 0;
                    
                    if (allPeopleData.length !== projectData.totalPeople && projectData.totalPeople > 0) {
                        createInitialData(projectData.totalPeople);
                    }
                    if(projectData.sessionStartTime && !timerInterval){
                        sessionStartTime = projectData.sessionStartTime.toDate();
                        startSessionTimer();
                    }
                } else {
                    // El documento no existe, crear uno con valores predeterminados
                    const defaultData = { title: "Gestión de Retratos", totalPeople: 108, sessionStartTime: serverTimestamp() };
                    setDoc(getProjectDoc(uid), defaultData).catch(e => console.error("Error al crear documento inicial:", e));
                    startSessionTimer();
                }
            });

            // Escuchar la colección de personas
            unsubscribePeople = onSnapshot(getPeopleCollection(uid), (querySnapshot) => {
                allPeopleData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateCounts(allPeopleData);
                renderPeopleList(allPeopleData, searchInput.value);
                loadingOverlayEl.style.display = 'none';
            });
        };

        // Función de inicialización
        const initApp = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                // Esperar a la autenticación del usuario
                const user = await new Promise((resolve, reject) => {
                    const unsubscribe = onAuthStateChanged(auth, user => {
                        unsubscribe();
                        resolve(user);
                    }, reject);
                });

                if (user) {
                    userId = user.uid;
                } else {
                    if (authToken) {
                        try {
                            const cred = await signInWithCustomToken(auth, authToken);
                            userId = cred.user.uid;
                        } catch (e) {
                            console.error("Error al iniciar sesión con token personalizado. Cayendo a sesión anónima.", e);
                            const cred = await signInAnonymously(auth);
                            userId = cred.user.uid;
                        }
                    } else {
                        const cred = await signInAnonymously(auth);
                        userId = cred.user.uid;
                    }
                }
                
                userIdDisplayEl.textContent = userId;
                setupFirestoreListeners(userId);
                populateModalSelects();

            } catch (e) {
                console.error("Error al inicializar Firebase o al autenticar:", e);
                loadingOverlayEl.style.display = 'none';
            }
        };

        window.onload = initApp;

    </script>
</body>
</html>
